<!DOCTYPE html>
<html>
  <head>
    <title><%=person.name%> | Profile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel='stylesheet' href='/stylesheets/style.css' />
    
    <link rel='stylesheet' href='/javascripts/bootstrap/css/bootstrap.css' type="text/css" />
    <link rel='stylesheet' href='/javascripts/bootstrap/css/bootstrap-responsive.css' type="text/css" />
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    <script src="/javascripts/bootstrap/js/bootstrap.js" type="text/javascript"></script>

	<script type="text/javascript">
		var attendances;
	
		$(function(){
			showAttendances();
			
			$("#feedback-form").submit(function() {
				var url = "/feedback/" + $("input[name=_id]").val();
				var data = { "feedback" : $("textarea[id=feedback]").val() }; 
	
				$.post(url, data);
				$("#feedback-form-modal").modal("hide");
				$("textarea[id=feedback]").val("");
				showAttendances();
				return false;
			});
		});

		function showAttendances()
		{
			$.getJSON("/attended/<%=person._id%>", function(atts) {
				attendances = {};
				var lines = [];
				lines.push("<ul>");
				$.each(atts, function(row, att){
					attendances[att._id] = att;
					lines.push("<li>" + att.event);
					if (att.feedback)
					{
						lines.push(" <a href='#' id='" + att._id + "' class='view-feedback-link'><i class='icon-certificate'></i>view feedback</a>");
					}
					else
					{
						lines.push(" <a href='#' id='" + att._id + "' class='leave-feedback-link'><i class='icon-plus'></i>leave feedback</a>");
					}
					lines.push("</li>");
				});
				lines.push("</ul>");
				$("#attendances").html(lines.join(""));
				enableFeedbackLinks();
			});
		}
	
		function enableFeedbackLinks()
		{
			$(".leave-feedback-link").click(function(e) {
				$("input[name=_id]").val($(this).attr("id"));
				$("#feedback-form-modal").modal("show");
				return false;
			});
			
			$(".view-feedback-link").click(function(e) {
				var attid = $(this).attr("id");
				var att = attendances[attid];
				$("#event").html(att.event);
				$("#feedback-view").html(att.feedback);
				$("#feedback-view-modal").modal("show");
			});
		};
	</script>
  </head>
  <body>
    <h1>Profile for <%=person.name%></h1>
    
    <h2>Attendances</h2>
    
    <div id="attendances"></div>
    
    <div id="feedback-form-modal" class="modal fade hide">
	    <form id="feedback-form" class="modal-form">
	    	<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	    		<h3>Leave feedback:</h3>
	    	</div>
	    	<div class="modal-body">
		    	<input type="hidden" name="_id"/>
		    	<textarea class="field span4" id="feedback"></textarea>
		    </div>
		    <div class="modal-footer">
		    	<button type="submit" class="btn">Submit</button>
		    </div>
	    </form>
	</div>
	
	<div id="feedback-view-modal" class="modal fade hide">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    		<h3>Feedback for <span id="event">event</span>:</h3>
    	</div>
		<div class="modal-body">
			<p id="feedback-view"></p>
		</div>
	</div>
	
  </body>
</html>
